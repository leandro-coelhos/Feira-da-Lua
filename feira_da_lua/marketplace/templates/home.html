{% extends "base.html" %}
{% load static %}
{% block title %}Feira da Lua - Encontre feiras e produtos{% endblock %}

{% block content %}
<main class="home-main">
  <section class="hero-section">
    <h1 class="hero-title">Descubra feiras e produtos perto de voce</h1>
    <p class="hero-subtitle">Encontre os melhores produtos e feirantes da sua regiao</p>
    
    <a href="{% url 'gps_location' %}" class="btn btn-primary" style="margin-bottom: 1.5rem; display: inline-block;">
      üìç Utilize sua localiza√ß√£o
    </a>
    
    <form method="get" action="{% url 'home' %}" class="search-container" id="search-form">
      <div class="search-box">
        <img src="{% static 'img/search.svg' %}" alt="Buscar" class="search-icon">
        {{ search_form.query }}
        <button type="submit" class="search-btn">Buscar</button>
      </div>
      
      <div class="search-type-container">
        <label class="search-type-label {% if search_type == 'feiras' %}active{% endif %}">
          <input type="radio" name="search_type" value="feiras" {% if search_type == 'feiras' %}checked{% endif %}>
          <span>Feiras</span>
        </label>
        <label class="search-type-label {% if search_type == 'produtos' %}active{% endif %}">
          <input type="radio" name="search_type" value="produtos" {% if search_type == 'produtos' %}checked{% endif %}>
          <span>Produtos</span>
        </label>
      </div>

      <div class="search-filters">
        <div class="filters-feiras {% if search_type != 'feiras' %}hidden{% endif %}" id="filters-feiras">
          <div class="filter-inline">
            <label class="filter-label-inline">Localizacao:</label>
            {{ marketplace_filter_form.location }}
          </div>
          <div class="filter-inline">
            <label class="filter-label-inline">Nota:</label>
            {{ marketplace_filter_form.min_rating }}
          </div>
        </div>

        <div class="filters-produtos {% if search_type != 'produtos' %}hidden{% endif %}" id="filters-produtos">
          <div class="filter-inline">
            <label class="filter-label-inline">Preco Min:</label>
            {{ product_filter_form.min_price }}
          </div>
          <div class="filter-inline">
            <label class="filter-label-inline">Preco Max:</label>
            {{ product_filter_form.max_price }}
          </div>
        </div>
      </div>
    </form>
  </section>

  <section class="results-section">
    {% if search_type == 'feiras' and marketplaces %}
    <h2 class="section-title">{% if query %}Feiras encontradas{% else %}Feiras Disponiveis{% endif %} ({{ marketplaces|length }})</h2>
    <div class="marketplaces-grid">
      {% for item in marketplaces %}
      <a href="{% url 'marketplace_detail' item.marketplace.id %}" class="marketplace-card">
        <div class="marketplace-info">
          <h3 class="marketplace-name">{{ item.marketplace.name }}</h3>
          <p class="marketplace-address">
            <img src="{% static 'img/Map pin.svg' %}" alt="" class="icon-small">
            {{ item.marketplace.address }}
          </p>
          <div class="marketplace-rating">
            {% for i in "12345" %}
              {% if forloop.counter <= item.average_rating %}
              <img src="{% static 'img/star_filled.svg' %}" alt="" class="star-icon">
              {% else %}
              <img src="{% static 'img/star.svg' %}" alt="" class="star-icon">
              {% endif %}
            {% endfor %}
            <span class="rating-text">{{ item.average_rating }} ({{ item.reviews_count }} avaliacoes)</span>
          </div>
          {% if item.distance %}
          <p class="marketplace-distance">{{ item.distance }} km de voce</p>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
    {% elif search_type == 'feiras' and is_searching and not marketplaces %}
    <div class="empty-state">
      <img src="{% static 'img/Map pin.svg' %}" alt="" class="empty-icon">
      <h3>Nenhuma feira encontrada</h3>
      <p>Tente buscar por outro termo ou localizacao</p>
    </div>
    {% endif %}

    {% if search_type == 'produtos' and products %}
    <h2 class="section-title">{% if query %}Produtos encontrados{% else %}Produtos Disponiveis{% endif %} ({{ products|length }})</h2>
    <div class="products-grid">
      {% for item in products %}
      {% if item.marketplace %}
      <a href="{% url 'marketplace_detail' item.marketplace.id %}" class="product-card" style="text-decoration: none; color: inherit; cursor: pointer;">
      {% else %}
      <div class="product-card">
      {% endif %}
        {% if item.photo_base64 %}
        <div class="product-image">
          <img src="data:image/jpeg;base64,{{ item.photo_base64 }}" alt="{{ item.product.name }}">
        </div>
        {% else %}
        <div class="product-image product-no-image">
          <img src="{% static 'img/Shopping cart.svg' %}" alt="Sem imagem">
        </div>
        {% endif %}
        <div class="product-info">
          <h3 class="product-name">{{ item.product.name }}</h3>
          <p class="product-price">R$ {{ item.product.price }}</p>
          {% if item.product.marketer %}
          <p class="product-seller">{{ item.product.marketer.user.complete_name }}</p>
          {% endif %}
          {% if item.marketplace %}
          <p class="product-marketplace" style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
            Feira: {{ item.marketplace.name }}
          </p>
          {% endif %}
        </div>
      {% if item.marketplace %}
      </a>
      {% else %}
      </div>
      {% endif %}
      {% endfor %}
    </div>
    {% elif search_type == 'produtos' and is_searching and not products %}
    <div class="empty-state">
      <img src="{% static 'img/Shopping cart.svg' %}" alt="" class="empty-icon">
      <h3>Nenhum produto encontrado</h3>
      <p>Tente buscar por outro termo</p>
    </div>
    {% endif %}

    {% if not is_searching %}
    <div class="welcome-section">
      <h2 class="section-title">Bem-vindo a Feira da Lua</h2>
      <p class="welcome-text">Use a barra de busca acima para encontrar feiras e produtos na sua regiao.</p>
      
      <div class="features-grid">
        <div class="feature-card">
          <img src="{% static 'img/search.svg' %}" alt="" class="feature-icon">
          <h3>Busque</h3>
          <p>Encontre feiras e produtos por nome ou localizacao</p>
        </div>
        <div class="feature-card">
          <img src="{% static 'img/Map pin.svg' %}" alt="" class="feature-icon">
          <h3>Localize</h3>
          <p>Use GPS para encontrar feiras proximas a voce</p>
        </div>
        <div class="feature-card">
          <img src="{% static 'img/star_filled.svg' %}" alt="" class="feature-icon">
          <h3>Avalie</h3>
          <p>Veja e deixe avaliacoes sobre as feiras</p>
        </div>
      </div>
    </div>
    {% endif %}
  </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
  document.querySelectorAll('input[name="search_type"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      var filtersFeiras = document.getElementById('filters-feiras');
      var filtersProdutos = document.getElementById('filters-produtos');
      var labels = document.querySelectorAll('.search-type-label');
      
      labels.forEach(function(label) {
        label.classList.remove('active');
      });
      this.parentElement.classList.add('active');
      
      if (this.value === 'feiras') {
        filtersFeiras.classList.remove('hidden');
        filtersProdutos.classList.add('hidden');
      } else {
        filtersFeiras.classList.add('hidden');
        filtersProdutos.classList.remove('hidden');
      }
    });
  });
</script>
{% endblock %}

